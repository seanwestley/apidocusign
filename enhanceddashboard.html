<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sonora Wealth KPC Onboarding Status</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }
    
    h1, h2, h3, .font-bold, .font-semibold {
      font-family: 'Inter', sans-serif;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #1e4882 0%, #2563eb 50%, #3b82f6 100%);
    }

    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }

    .status-card {
      background: linear-gradient(135deg, #1e4882 0%, #2563eb 100%);
      transition: all 0.3s ease;
      transform: translateY(0);
    }

    .status-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 25px -5px rgba(30, 72, 130, 0.3);
    }

    .btn-orange {
      background: linear-gradient(135deg, #f47c3c 0%, #ff6b35 100%);
      color: white;
      border: none;
      transition: all 0.3s ease;
    }

    .btn-orange:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(244, 124, 60, 0.3);
    }
    
    .bluebtn {
      background: linear-gradient(135deg, #1e4882 0%, #2563eb 100%);
      color: white;
      display: flex;
      justify-content: center;
      border: none;
      transition: all 0.3s ease;
      border-radius: 8px;
      padding: 8px 16px;
    }

    .bluebtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(30, 72, 130, 0.3);
      color: white;
    }

    .dataTables_wrapper .dataTables_filter input,
    .dataTables_wrapper .dataTables_length select {
      border-radius: 8px;
      border: 2px solid #e5e7eb;
      padding: 8px 12px;
      transition: all 0.3s ease;
    }

    .dataTables_wrapper .dataTables_filter input:focus,
    .dataTables_wrapper .dataTables_length select:focus {
      border-color: #1e4882;
      box-shadow: 0 0 0 3px rgba(30, 72, 130, 0.1);
      outline: none;
    }

    @media only screen and (max-width: 1024px) {
      .container {
        max-width: 100% !important;
      }
    } 

    @media only screen and (max-width: 600px) {
      .dataTables_wrapper .col-sm-12 {
        width: 100%;
        overflow: scroll;
        margin-top: 20px;
        overflow-x: auto !important;
        white-space: nowrap;
        display: block;
        padding: 10px !important; 
      }
      table#envelopes {
        width: 1000px !important;
      }
    }

    @keyframes fade-in {
      from { 
        opacity: 0; 
        transform: translateY(20px);
      }
      to { 
        opacity: 1; 
        transform: translateY(0);
      }
    }

    @keyframes pulse-glow {
      0%, 100% { 
        box-shadow: 0 0 20px rgba(30, 72, 130, 0.3);
      }
      50% { 
        box-shadow: 0 0 30px rgba(30, 72, 130, 0.5);
      }
    }

    .animate-fade-in {
      animation: fade-in 0.8s ease-out forwards;
    }

    .animate-pulse-glow {
      animation: pulse-glow 2s ease-in-out infinite;
    }

    /* Enhanced skeleton loading */
    .skeleton-card {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    div#dashboard .pagination li a {
      box-shadow: none !important;
      background: transparent;
      border: 2px solid #1e4882 !important;
      color: #1e4882 !important;
      border-radius: 8px;
      margin: 0 2px;
      transition: all 0.3s ease;
    }

    div#dashboard .pagination li.active a {
      box-shadow: none !important;
      background: linear-gradient(135deg, #1e4882 0%, #2563eb 100%);
      border: 2px solid #1e4882 !important;
      color: #fff !important;
    }

    div#dashboard .pagination li a:hover {
      background: linear-gradient(135deg, #1e4882 0%, #2563eb 100%) !important;
      color: #fff !important;
      transform: translateY(-2px);
    }

    th.sorting, th.sorting_asc, th.sorting_desc {
      text-align: center;
      background: linear-gradient(135deg, #1e4882 0%, #2563eb 100%);
      color: white;
      font-weight: 600;
      padding: 15px 8px;
    }

    .table-bordered th, .table-bordered td {
      border: 1px solid #e5e7eb;
      padding: 12px 8px;
    }

    .table tbody tr:hover {
      background-color: rgba(30, 72, 130, 0.05);
      transition: all 0.3s ease;
    }

    /* Enhanced status badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 12px;
      text-transform: capitalize;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .status-completed {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .status-in-progress {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
    }

    .status-voided {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      color: white;
    }

    .status-deleted {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }

    .status-default {
      background: linear-gradient(135deg, #1e4882 0%, #2563eb 100%);
      color: white;
    }
  </style>
</head>
<body class="text-gray-800">
  <div class="container mx-auto px-4 py-8">

    <!-- Enhanced Header -->
    <div class="text-center mb-12">
      <div class="gradient-bg rounded-3xl p-8 glass-effect animate-pulse-glow">
        <div class="flex items-center justify-center mb-4">
          <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mr-4">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
          </div>
          <div>
            <h1 class="text-4xl sm:text-5xl font-bold text-white mb-2">Sonora Wealth KPC</h1>
            <h2 class="text-2xl sm:text-3xl font-semibold text-blue-100">Onboarding Status</h2>
          </div>
        </div>
        <p class="text-lg text-blue-100 font-medium">Powered by KPCx • Real-time Dashboard</p>
      </div>
    </div>

    <!-- Enhanced Skeleton Placeholder -->
    <div id="skeleton" class="space-y-8">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="h-80 skeleton-card rounded-2xl"></div>
        <div class="h-80 skeleton-card rounded-2xl"></div>
        <div class="h-80 skeleton-card rounded-2xl"></div>
      </div>
      <div class="h-96 skeleton-card rounded-2xl"></div>
    </div>

    <!-- Enhanced Dashboard -->
    <div id="dashboard" class="hidden">

      <!-- Enhanced Charts Section -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
        
        <!-- Pie Chart Card -->
        <div class="glass-effect rounded-2xl p-6 shadow-xl hover:shadow-2xl transition-all duration-300">
          <div class="flex items-center mb-4">
            <div class="w-10 h-10 gradient-bg rounded-lg flex items-center justify-center mr-3">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-800">Status Distribution</h3>
          </div>
          <div class="chart-container">
            <canvas id="statusPieChart"></canvas>
          </div>
        </div>

        <!-- Bar Chart Card -->
        <div class="glass-effect rounded-2xl p-6 shadow-xl hover:shadow-2xl transition-all duration-300">
          <div class="flex items-center mb-4">
            <div class="w-10 h-10 gradient-bg rounded-lg flex items-center justify-center mr-3">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-800">Envelope Count</h3>
          </div>
          <div class="chart-container">
            <canvas id="statusBarChart"></canvas>
          </div>
        </div>

        <!-- Status Summary Card -->
        <div class="glass-effect rounded-2xl p-6 shadow-xl hover:shadow-2xl transition-all duration-300">
          <div class="flex items-center mb-6">
            <div class="w-10 h-10 gradient-bg rounded-lg flex items-center justify-center mr-3">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-800">Status Summary</h3>
          </div>
          <div id="statusGrid" class="grid grid-cols-2 gap-4"></div>
        </div>
      </div>

      <!-- Enhanced Table Section -->
      <div class="glass-effect rounded-2xl p-6 shadow-xl">
        <div class="flex items-center mb-6">
          <div class="w-12 h-12 gradient-bg rounded-xl flex items-center justify-center mr-4">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-gray-800">Envelope Management</h2>
            <p class="text-gray-600">Track and manage all envelope statuses</p>
          </div>
        </div>
        
        <div class="overflow-x-auto">
          <table id="envelopes" class="table table-bordered w-full min-w-[600px] bg-white text-sm sm:text-base rounded-lg overflow-hidden">
            <thead>
              <tr>
                <th class="text-center">📋 Investment Management</th>
                <th class="text-center">💰 Investment</th>
                <th class="text-center">📊 Status</th>
                <th class="text-center">👤 Next Signer</th>
                <th class="text-center">🕒 Updated</th>
                <th class="text-center">👁️ Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
<script>
  fetch('https://docusign-portal.netlify.app/.netlify/functions/fetchsonora')
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector('#envelopes tbody');
      const statusCounts = {};
      const fetchPromises = [];

         data.forEach(item => {
          const subject = item.emailSubject || '—';
          const status = item.status || '—';
          const updated = item.statusChangedDateTime ? new Date(item.statusChangedDateTime).toLocaleString() : '—';
          const envelopeId = item.envelopeId || '—';

          const fetchRecipientAndAmount = Promise.all([
            fetch(`https://docusign-portal.netlify.app/.netlify/functions/getRecipients?id=${envelopeId}`).then(res => res.json()),
            fetch(`https://docusign-portal.netlify.app/.netlify/functions/fetchfields?id=${envelopeId}`)
              .then(res => res.json())
              .then(tabData => {
                const investTab = tabData.numberTabs?.find(tab => tab.tabLabel === 'INVEST AMOUNT' && tab.documentId === "1");
                return investTab?.value || '—';
              })
              .catch(() => '—')
          ])
          .then(([recipientData, investedAmount]) => {
            const nextSigner = recipientData.signers?.find(signer => signer.status !== "completed")?.name || '—';
            statusCounts[status] = (statusCounts[status] || 0) + 1;

            // Enhanced status badge with icons
            const getStatusBadge = (status) => {
              const statusLower = status.toLowerCase();
              let badgeClass = 'status-default';
              let icon = '📄';
              
              if (statusLower === 'completed') {
                badgeClass = 'status-completed';
                icon = '✅';
              } else if (statusLower === 'in progress') {
                badgeClass = 'status-in-progress';
                icon = '⏳';
              } else if (statusLower === 'voided') {
                badgeClass = 'status-voided';
                icon = '❌';
              } else if (statusLower === 'deleted') {
                badgeClass = 'status-deleted';
                icon = '🗑️';
              }
              
              return `<span class="status-badge ${badgeClass}">${icon} ${status}</span>`;
            };

            const statusBadge = getStatusBadge(status);
            const viewLink = `<a href="/viewEnvelope.html?id=${envelopeId}" class="btn btn-sm bluebtn">👁️ View</a>`;

            tbody.insertAdjacentHTML('beforeend', `
              <tr class="hover:bg-blue-50 transition-colors">
                <td class="font-medium">${subject}</td>
                <td class="text-center font-semibold text-green-600">$${investedAmount}</td>
                <td class="text-center">${statusBadge}</td>
                <td class="text-center">${nextSigner}</td>
                <td class="text-center text-gray-600">${updated}</td>
                <td class="text-center">${viewLink}</td>
              </tr>
            `);
          })
          .catch(err => {
            console.error('Error fetching data:', err);
            tbody.insertAdjacentHTML('beforeend', `
              <tr>
                <td colspan="6" class="text-center text-red-600 py-8">
                  <div class="flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Error loading envelope data
                  </div>
                </td>
              </tr>
            `);
          });

          fetchPromises.push(fetchRecipientAndAmount);
        });

      Promise.all(fetchPromises).then(() => {
        initializeCharts(statusCounts);
        $('#envelopes').DataTable({
         pageLength: 100,
          autoWidth: false,
          order: [[4, 'desc']], // Updated column index for "Updated"
          columnDefs: [
            { targets: 0, width: '35%' }, // Subject
            { targets: 1, width: '15%' }, // Invested Amount
            { targets: 2, width: '15%' }, // Status
            { targets: 3, width: '15%' }, // Next Signer
            { targets: 4, width: '15%' }, // Updated
            { targets: 5, width: '10%' }, // View
          ],
          language: {
            search: "🔍 Search envelopes:",
            lengthMenu: "Show _MENU_ envelopes per page",
            info: "Showing _START_ to _END_ of _TOTAL_ envelopes",
            paginate: {
              first: "⏮️",
              last: "⏭️",
              next: "▶️",
              previous: "◀️"
            }
          }
        });

        updateStatusGrid(statusCounts);
        document.getElementById('skeleton').style.display = 'none';
        const dash = document.getElementById('dashboard');
        dash.classList.remove('hidden');
        dash.classList.add('animate-fade-in');
      }).catch(err => {
        document.body.innerHTML += `<div class="fixed top-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-lg">Error loading data: ${err.message}</div>`;
      });
    })
    .catch(err => {
      document.body.innerHTML += `<div class="fixed top-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-lg">Error loading data: ${err.message}</div>`;
    });

  function initializeCharts(statusCounts) {
    const palette = {
      completed: '#10b981',
      'In Progress': '#f59e0b',
      voided: '#6b7280',
      deleted: '#ef4444',
      status: '#f47c3c',
      default: '#1e4882'
    };

    // Enhanced Pie Chart
    new Chart(document.getElementById('statusPieChart'), {
      type: 'doughnut',
      data: {
        labels: Object.keys(statusCounts),
        datasets: [{
          data: Object.values(statusCounts),
          backgroundColor: Object.keys(statusCounts).map(status => palette[status] || palette.default),
          borderWidth: 3,
          borderColor: '#ffffff',
          hoverBorderWidth: 5,
          hoverOffset: 10
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            position: 'bottom',
            labels: {
              padding: 20,
              usePointStyle: true,
              font: { size: 12, weight: '600' }
            }
          },
          title: { 
            display: true, 
            text: 'Status Distribution',
            font: { size: 16, weight: 'bold' },
            padding: 20
          }
        },
        cutout: '60%'
      }
    });

    // Enhanced Bar Chart
    new Chart(document.getElementById('statusBarChart'), {
      type: 'bar',
      data: {
        labels: Object.keys(statusCounts),
        datasets: [{
          label: 'Envelope Count',
          data: Object.values(statusCounts),
          backgroundColor: Object.keys(statusCounts).map(status => palette[status] || palette.default),
          borderRadius: 8,
          borderSkipped: false,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: { 
            display: true, 
            text: 'Envelope Count by Status',
            font: { size: 16, weight: 'bold' },
            padding: 20
          },
          legend: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { 
              stepSize: 1,
              font: { weight: '600' }
            },
            grid: { color: 'rgba(0,0,0,0.1)' }
          },
          x: {
            ticks: { font: { weight: '600' } },
            grid: { display: false }
          }
        }
      }
    });
  }

  function updateStatusGrid(statusCounts) {
    const grid = document.getElementById('statusGrid');
    const statusIcons = {
      'completed': '✅',
      'in progress': '⏳',
      'voided': '❌',
      'deleted': '🗑️'
    };
    
    Object.entries(statusCounts).forEach(([status, count]) => {
      const card = document.createElement('div');
      const icon = statusIcons[status.toLowerCase()] || '📄';
      card.className = "status-card rounded-xl p-4 text-center text-white font-semibold shadow-lg";
      card.innerHTML = `
        <div class="text-2xl mb-2">${icon}</div>
        <div class="text-sm opacity-90 mb-1">${status}</div>
        <div class="text-2xl font-bold">${count}</div>
      `;
      grid.appendChild(card);
    });
  }
</script>

</body>
</html>
