<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Corecap Investment Management - Bruce Maginn</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-blue: #0B3041;
      --secondary-blue: #118DD1;
      --success-green: #196B24;
      --warning-orange: #E97132;
      --danger-red: #ef4444;
      --neutral-gray: #6b7280;
    }
    body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); }
    .hero-gradient { background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%); }
    .glass-card { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); }
    .chart-container { height: 320px; }
    .status-badge { padding: 8px 16px; border-radius: 25px; font-weight: 700; font-size: 12px; }
    .status-completed { background: var(--success-green); color: white; }
    .status-in-progress { background: var(--warning-orange); color: white; }
    .status-voided { background: var(--neutral-gray); color: white; }
    .status-deleted { background: var(--danger-red); color: white; }
    .status-sent { background: var(--secondary-blue); color: white; }
    .status-default { background: var(--primary-blue); color: white; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="hero-gradient text-white py-6 shadow-lg">
    <div class="container mx-auto text-center">
      <h1 class="text-3xl font-bold">Corecap | KPC Private Funds</h1>
      <p class="opacity-80">Client Onboarding - Bruce Maginn</p>
    </div>
  </div>

  <div class="container mx-auto px-4 py-8 max-w-full">
    <!-- Loading Skeleton -->
    <div id="skeleton" class="space-y-8">
      <div class="grid grid-cols-3 gap-8">
        <div class="h-96 bg-gray-200 animate-pulse rounded-3xl"></div>
        <div class="h-96 bg-gray-200 animate-pulse rounded-3xl"></div>
        <div class="h-96 bg-gray-200 animate-pulse rounded-3xl"></div>
      </div>
      <div class="h-96 bg-gray-200 animate-pulse rounded-3xl"></div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
      <!-- Charts -->
      <div class="grid grid-cols-3 gap-8 mb-12">
        <div class="glass-card rounded-3xl p-8">
          <h3 class="text-xl font-bold mb-4 text-center">Status Distribution</h3>
          <div class="chart-container"><canvas id="statusPieChart"></canvas></div>
        </div>
        <div class="glass-card rounded-3xl p-8">
          <h3 class="text-xl font-bold mb-4 text-center">Envelope Count</h3>
          <div class="chart-container"><canvas id="statusBarChart"></canvas></div>
        </div>
        <div class="glass-card rounded-3xl p-8">
          <h3 class="text-xl font-bold mb-4 text-center">Status Summary</h3>
          <div id="statusGrid" class="grid grid-cols-2 gap-6 mt-8"></div>
        </div>
      </div>

      <!-- Table -->
      <div class="glass-card rounded-3xl p-8">
        <h2 class="text-2xl font-bold mb-4">Envelope Management</h2>
        <div class="overflow-x-auto">
          <table id="envelopes" class="table table-bordered w-full">
            <thead>
              <tr>
                <th>Investor Name</th>
                <th>Email</th>
                <th>IA Firm</th>
                <th>IA Contact</th>
                <th>Investment</th>
                <th>Status</th>
                <th>Created</th>
                <th>Completed</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    fetch('/.netlify/functions/adwance')
      .then(res => res.json())
      .then(data => {
        const tbody = document.querySelector('#envelopes tbody');
        const envelopes = data.envelopes || [];
        const statusCounts = {};

        envelopes.forEach(env => {
          const f = env.formData || {};
          const investorName = f['Full Name'] || f['Name'] || '—';
          const investorEmail = f['Email'] || '—';
          const iaFirm = f['IA Firm Name'] || '—';
          const iaContact = f['IA Contact Name'] || '—';
          const investAmount = f['INVEST AMOUNT'] || '—';
          const status = env.status || '—';
          const created = env.createdDateTime ? new Date(env.createdDateTime).toLocaleString() : '—';
          const completed = env.completedDateTime ? new Date(env.completedDateTime).toLocaleString() : '—';

          statusCounts[status] = (statusCounts[status] || 0) + 1;

          const getStatusBadge = (s) => {
            const sl = s.toLowerCase();
            if (sl === 'completed') return `<span class="status-badge status-completed">${s}</span>`;
            if (sl === 'in progress') return `<span class="status-badge status-in-progress">${s}</span>`;
            if (sl === 'voided') return `<span class="status-badge status-voided">${s}</span>`;
            if (sl === 'deleted') return `<span class="status-badge status-deleted">${s}</span>`;
            if (sl === 'sent') return `<span class="status-badge status-sent">${s}</span>`;
            return `<span class="status-badge status-default">${s}</span>`;
          };

          tbody.insertAdjacentHTML('beforeend', `
            <tr>
              <td>${investorName}</td>
              <td>${investorEmail}</td>
              <td>${iaFirm}</td>
              <td>${iaContact}</td>
              <td>$${investAmount}</td>
              <td>${getStatusBadge(status)}</td>
              <td>${created}</td>
              <td>${completed}</td>
            </tr>
          `);
        });

        // DataTable
        $('#envelopes').DataTable({ pageLength: 25, order: [[6, 'desc']] });

        // Charts
        const palette = {
          completed: '#10b981',
          'in progress': '#f59e0b',
          voided: '#6b7280',
          deleted: '#ef4444',
          sent: '#1e4882',
          default: '#1e4882'
        };

        new Chart(document.getElementById('statusPieChart'), {
          type: 'doughnut',
          data: {
            labels: Object.keys(statusCounts),
            datasets: [{
              data: Object.values(statusCounts),
              backgroundColor: Object.keys(statusCounts).map(s => palette[s.toLowerCase()] || palette.default)
            }]
          },
          options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });

        new Chart(document.getElementById('statusBarChart'), {
          type: 'bar',
          data: {
            labels: Object.keys(statusCounts),
            datasets: [{
              label: 'Count',
              data: Object.values(statusCounts),
              backgroundColor: Object.keys(statusCounts).map(s => palette[s.toLowerCase()] || palette.default),
              borderRadius: 8
            }]
          },
          options: { responsive: true, plugins: { legend: { display: false } } }
        });

        const grid = document.getElementById('statusGrid');
        Object.entries(statusCounts).forEach(([s, count]) => {
          grid.insertAdjacentHTML('beforeend', `
            <div class="status-card rounded-2xl p-6 text-center text-white font-bold shadow-lg" style="background: ${palette[s.toLowerCase()] || palette.default}">
              <div class="text-sm mb-2 uppercase">${s}</div>
              <div class="text-3xl">${count}</div>
            </div>
          `);
        });

        // Show dashboard
        document.getElementById('skeleton').style.display = 'none';
        document.getElementById('dashboard').classList.remove('hidden');
      })
      .catch(err => {
        console.error('Error:', err);
        document.getElementById('skeleton').innerText = 'Failed to load data.';
      });
  </script>
</body>
</html>
